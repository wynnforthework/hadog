# hadog
> 家庭自动化帮助工具，通过蓝牙判断回家/离家，通过mqtt消息通知ha执行自动化。

### 环境
1. .net framework 4.7.2
2. mqtt
3. bluetooth
4. windows
5. visual studio 2019

### 尝试过的方案
1. ai-nice硬件，根据介绍，这款硬件是能够判断回家还是离家的，但由于硬件一直没有发布，且发布日期不确定，暂不考虑。
2. 智能锁，由于我使用的智能家居都是米家系，考虑到联动，最好是买一款米家系的智能锁，通过从内外开门来判断回家/离家，但由于我用的不是米家系，做不到这一点，且不支持ha，暂不考虑。
3. monitor，该方案是基于树莓派zero w的低功耗蓝牙，不断的搜索蓝牙设备出现来实现的，且可以多个树莓派组成分布式，但是树莓派的成本过高，遂放弃。
4. ESP32-MQTT-ROOM，该方案类似于树莓派，区别是成本是树莓派的1/10左右，没尝试过。
5. room-assistant，基于蓝牙，多种安装方式docker/add-on，但由于我的nas是7.1，不支持usb蓝牙，只能放弃。

### 我的方案
1. 目前已知的回家/离家判断方案基本上都是基于智能锁/wifi/蓝牙，由于智能锁和WiFi都需要指定设备，而笔记本自带蓝牙，最终还是考虑使用蓝牙的方案，但不是基于开发板，参考monitor方案，决定使用dotnet写一个控制台应用，监听蓝牙设备。
2. 蓝牙方案的缺点：  
2.1. iPhone锁屏待机3分钟后，蓝牙搜索不到  
2.2. 蓝牙的mac地址会经常变  
2.3. 需要随身携带手机
3. 蓝牙方案的优点  
3.1. 能判断多人场景

### 回家/离家判断策略
1. 当注册设备都不在时，出现一个注册设备算回家，打开玄关灯，2分钟后关闭，再根据日落日出来判断是否需要开卧室射灯，如果窗户是关闭状态，温度超过26度，打开空调
2. 当有一个以上设备在线时，新设备离线或在线只做记录，不触发任何事件
3. 当所有设备不在线时，算离家，关闭所有灯和空调，洗衣机、烘干机和冰箱等家电不做处理，如果当天没有扫过地则打开扫地机器人，扫地次数+1
